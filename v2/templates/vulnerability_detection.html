{% extends "layout.html" %}

{% block title %}Vulnerability Detection{% endblock %}

{% block head %}
<style>
    .slider-container {
        margin-bottom: 15px;
    }
    .slider-value {
        font-weight: bold;
        margin-left: 10px;
    }
    .risk-high {
        color: #dc3545;
    }
    .risk-medium {
        color: #fd7e14;
    }
    .risk-low {
        color: #28a745;
    }
    .loading-spinner {
        display: none;
    }
    .result-container {
        display: none;
    }
    .feature-info-icon {
        cursor: pointer;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-search me-2"></i>Vulnerability
                    Detection</h4>
            </div>
            <div class="card-body">
                <p>Analyze security features and detect potential
                    vulnerabilities in mobile applications. Adjust the sliders
                    below to set security feature values (0-1 scale).</p>

                <form id="vulnerability-form">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">Data Security
                                    Features</div>
                                <div class="card-body">
                                    <div class="slider-container">
                                        <label for="storage-encryption">
                                            Storage Encryption Level
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Measures how well the app encrypts stored data. Higher values indicate stronger encryption."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="storage-encryption" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="storage-encryption-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="data-transmission">
                                            Data Transmission Security
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Evaluates the security of data in transit. Higher values indicate better protection during transmission."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="data-transmission" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="data-transmission-value">0.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">API Security
                                    Features</div>
                                <div class="card-body">
                                    <div class="slider-container">
                                        <label for="api-security">
                                            API Security Score
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Measures the overall security of API implementations. Higher values indicate better API security practices."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="api-security" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="api-security-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="input-validation">
                                            Input Validation Score
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Evaluates how well the app validates and sanitizes inputs. Higher values indicate better input validation."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="input-validation" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="input-validation-value">0.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-light">Authentication
                                    & Network Features</div>
                                <div class="card-body">
                                    <div class="slider-container">
                                        <label for="authentication-strength">
                                            Authentication Strength
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Measures the strength of authentication mechanisms. Higher values indicate stronger authentication."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="authentication-strength"
                                                min="0" max="1" step="0.1"
                                                value="0.5">
                                            <span class="slider-value"
                                                id="authentication-strength-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="network-security">
                                            Network Communication Security
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Evaluates the security of network communications. Higher values indicate better network security practices."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="network-security" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="network-security-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="certificate-pinning">
                                            Certificate Pinning Implementation
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Measures the implementation of certificate pinning. Higher values indicate better certificate pinning practices."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="certificate-pinning" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="certificate-pinning-value">0.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="card mb-3">
                                <div class="card-header bg-light">Additional
                                    Security Features</div>
                                <div class="card-body">
                                    <div class="slider-container">
                                        <label for="third-party-risk">
                                            Third Party Library Risk
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Evaluates the risk associated with third-party libraries. Lower values indicate higher risk."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="third-party-risk" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="third-party-risk-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="permissions-management">
                                            Runtime Permissions Management
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Measures how well the app manages runtime permissions. Higher values indicate better permissions management."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="permissions-management"
                                                min="0" max="1" step="0.1"
                                                value="0.5">
                                            <span class="slider-value"
                                                id="permissions-management-value">0.5</span>
                                        </div>
                                    </div>

                                    <div class="slider-container">
                                        <label for="code-obfuscation">
                                            Code Obfuscation Level
                                            <i
                                                class="fas fa-info-circle feature-info-icon"
                                                data-bs-toggle="tooltip"
                                                title="Evaluates the level of code obfuscation. Higher values indicate better code obfuscation practices."></i>
                                        </label>
                                        <div class="d-flex align-items-center">
                                            <input type="range"
                                                class="form-range"
                                                id="code-obfuscation" min="0"
                                                max="1" step="0.1" value="0.5">
                                            <span class="slider-value"
                                                id="code-obfuscation-value">0.5</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <div class="col-12 text-center">
                            <button type="submit"
                                class="btn btn-primary btn-lg">
                                <i class="fas fa-search me-2"></i>Detect
                                Vulnerabilities
                            </button>
                        </div>
                    </div>
                </form>

                <div class="loading-spinner text-center mt-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing security features...</p>
                </div>

                <div class="result-container mt-4" id="result-container">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0"><i
                                            class="fas fa-exclamation-triangle me-2"></i>Vulnerability
                                        Assessment</h5>
                                </div>
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <i
                                            class="fas fa-robot me-2"></i>AI-Powered
                                        Improvement Suggestions
                                    </div>
                                    <div class="card-body">
                                        <div id="ai-suggestions"
                                            class="suggestions-container">
                                            <div class="alert alert-info">
                                                <i
                                                    class="fas fa-info-circle me-2"></i>
                                                Adjust the security feature
                                                values above to receive
                                                personalized AI-powered
                                                suggestions for improving your
                                                application's security.
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div
                                        class="d-flex justify-content-center mb-3">
                                        <div class="position-relative"
                                            style="width: 200px; height: 200px;">
                                            <canvas
                                                id="vulnerability-gauge"></canvas>
                                            <div
                                                class="position-absolute top-50 start-50 translate-middle text-center">
                                                <h3
                                                    id="vulnerability-score">0%</h3>
                                                <p id="vulnerability-level">Low
                                                    Risk</p>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="vulnerability-breakdown">
                                        <h6>Vulnerability Breakdown:</h6>
                                        <ul class="list-group list-group-flush"
                                            id="vulnerability-list">
                                            <!-- Populated by JavaScript -->
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card mb-3">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i
                                            class="fas fa-file-alt me-2"></i>Security
                                        Report</h5>
                                </div>
                                <div class="card-body">
                                    <pre id="security-report"
                                        class="p-3 bg-light"
                                        style="max-height: 300px; overflow-y: auto;"><!-- Populated by JavaScript --></pre>

                                    <div class="mt-3">
                                        <button id="generate-pdf"
                                            class="btn btn-success">
                                            <i
                                                class="fas fa-file-pdf me-2"></i>Generate
                                            PDF Report
                                        </button>
                                        <a id="download-pdf"
                                            class="btn btn-outline-primary d-none">
                                            <i
                                                class="fas fa-download me-2"></i>Download
                                            PDF Report
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i
                                            class="fas fa-chart-bar me-2"></i>Risk
                                        Factor Analysis</h5>
                                </div>
                                <div class="card-body">
                                    <canvas id="risk-factors-chart"
                                        height="100"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Update slider values and generate suggestions
    document.querySelectorAll('.form-range').forEach(function(slider) {
        slider.addEventListener('input', function() {
            document.getElementById(this.id + '-value').textContent = this.value;
            generateAISuggestions();
        });
    });

    function generateAISuggestions() {
        const securityMetrics = {
            'storage-encryption': parseFloat(document.getElementById('storage-encryption').value),
            'data-transmission': parseFloat(document.getElementById('data-transmission').value),
            'api-security': parseFloat(document.getElementById('api-security').value),
            'input-validation': parseFloat(document.getElementById('input-validation').value),
            'authentication-strength': parseFloat(document.getElementById('authentication-strength').value),
            'network-security': parseFloat(document.getElementById('network-security').value),
            'certificate-pinning': parseFloat(document.getElementById('certificate-pinning').value)
        };

        const suggestions = [];

        // Generate suggestions based on security metrics
        if (securityMetrics['storage-encryption'] < 0.7) {
            suggestions.push({
                severity: 'high',
                feature: 'Storage Encryption',
                suggestion: 'Implement AES-256 encryption for sensitive data storage and ensure secure key management.',
                details: 'Use strong encryption algorithms and proper key derivation functions (e.g., PBKDF2) for data at rest.'
            });
        }

        if (securityMetrics['data-transmission'] < 0.7) {
            suggestions.push({
                severity: 'high',
                feature: 'Data Transmission',
                suggestion: 'Enforce TLS 1.3 for all network communications and implement certificate pinning.',
                details: 'Ensure all API endpoints use HTTPS and implement proper certificate validation.'
            });
        }

        if (securityMetrics['api-security'] < 0.7) {
            suggestions.push({
                severity: 'high',
                feature: 'API Security',
                suggestion: 'Implement robust API authentication and rate limiting mechanisms.',
                details: 'Use OAuth 2.0 with refresh tokens and implement API versioning for better security control.'
            });
        }

        if (securityMetrics['input-validation'] < 0.7) {
            suggestions.push({
                severity: 'medium',
                feature: 'Input Validation',
                suggestion: 'Implement comprehensive input validation and sanitization.',
                details: 'Use parameterized queries and validate all user inputs against XSS and injection attacks.'
            });
        }

        if (securityMetrics['authentication-strength'] < 0.7) {
            suggestions.push({
                severity: 'high',
                feature: 'Authentication',
                suggestion: 'Implement multi-factor authentication and secure password policies.',
                details: 'Use biometric authentication when available and implement account lockout policies.'
            });
        }

        if (securityMetrics['network-security'] < 0.7) {
            suggestions.push({
                severity: 'medium',
                feature: 'Network Security',
                suggestion: 'Implement secure session management and traffic encryption.',
                details: 'Use secure WebSocket connections and implement proper session timeout mechanisms.'
            });
        }

        if (securityMetrics['certificate-pinning'] < 0.7) {
            suggestions.push({
                severity: 'medium',
                feature: 'Certificate Pinning',
                suggestion: 'Implement certificate pinning for all network communications.',
                details: 'Use public key pinning and maintain a backup pin set for certificate rotation.'
            });
        }

        // Display suggestions
        const suggestionsContainer = document.getElementById('ai-suggestions');
        if (suggestions.length === 0) {
            suggestionsContainer.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Great job! Your security implementation meets or exceeds recommended thresholds.
                </div>
            `;
        } else {
            const suggestionHTML = suggestions.map(suggestion => `
                <div class="alert ${suggestion.severity === 'high' ? 'alert-danger' : 'alert-warning'} mb-3">
                    <div class="d-flex align-items-center mb-2">
                        <i class="fas ${suggestion.severity === 'high' ? 'fa-exclamation-triangle' : 'fa-exclamation-circle'} me-2"></i>
                        <strong>${suggestion.feature}</strong>
                        <span class="badge ${suggestion.severity === 'high' ? 'bg-danger' : 'bg-warning'} ms-2">${suggestion.severity.toUpperCase()}</span>
                    </div>
                    <p class="mb-2">${suggestion.suggestion}</p>
                    <small class="text-muted">${suggestion.details}</small>
                </div>
            `).join('');

            suggestionsContainer.innerHTML = suggestionHTML;
        }
    }

    // Initial suggestions generation
    generateAISuggestions();
    
    // Vulnerability detection form submission
    document.getElementById('vulnerability-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading spinner
        document.querySelector('.loading-spinner').style.display = 'block';
        document.querySelector('.result-container').style.display = 'none';
        
        // Collect security features
        const securityFeatures = {
            storage_encryption_level: parseFloat(document.getElementById('storage-encryption').value),
            api_security_score: parseFloat(document.getElementById('api-security').value),
            data_transmission_security: parseFloat(document.getElementById('data-transmission').value),
            authentication_strength: parseFloat(document.getElementById('authentication-strength').value),
            input_validation_score: parseFloat(document.getElementById('input-validation').value),
            network_communication_security: parseFloat(document.getElementById('network-security').value),
            third_party_library_risk: parseFloat(document.getElementById('third-party-risk').value),
            runtime_permissions_management: parseFloat(document.getElementById('permissions-management').value),
            code_obfuscation_level: parseFloat(document.getElementById('code-obfuscation').value),
            certificate_pinning_implementation: parseFloat(document.getElementById('certificate-pinning').value)
        };
        
        // Send API request
        fetch('/api/detect-vulnerabilities', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(securityFeatures)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide loading spinner and show results
                document.querySelector('.loading-spinner').style.display = 'none';
                document.querySelector('.result-container').style.display = 'block';
                
                // Update vulnerability gauge
                updateVulnerabilityGauge(data.results.total_vulnerability_score);
                
                // Update vulnerability breakdown
                updateVulnerabilityBreakdown(data.results.vulnerability_breakdown);
                
                // Update security report
                document.getElementById('security-report').textContent = data.report;
                
                // Update risk factors chart
                updateRiskFactorsChart(data.results.risk_factors);
                
                // Reset PDF download button
                document.getElementById('download-pdf').classList.add('d-none');
                document.getElementById('generate-pdf').classList.remove('d-none');
                
                // Store results for PDF generation
                window.vulnerabilityResults = data.results;
            } else {
                alert('Error: ' + data.error);
                document.querySelector('.loading-spinner').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while processing your request.');
            document.querySelector('.loading-spinner').style.display = 'none';
        });
    });
    
    // Generate PDF report
    document.getElementById('generate-pdf').addEventListener('click', function() {
        if (!window.vulnerabilityResults) {
            alert('No vulnerability results available. Please run a detection first.');
            return;
        }
        
        // Show loading state
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating PDF...';
        
        // Get app name (could be customized in a real implementation)
        const appName = 'Mobile Application';
        
        // Send API request
        fetch('/api/generate-pdf-report', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                results: window.vulnerabilityResults,
                app_name: appName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Hide generate button and show download button
                this.classList.add('d-none');
                const downloadBtn = document.getElementById('download-pdf');
                downloadBtn.classList.remove('d-none');
                downloadBtn.href = '/api/download-report/' + data.pdf_path;
                downloadBtn.download = 'security_report.pdf';
            } else {
                alert('Error: ' + data.error);
                this.disabled = false;
                this.innerHTML = '<i class="fas fa-file-pdf me-2"></i>Generate PDF Report';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while generating the PDF report.');
            this.disabled = false;
            this.innerHTML = '<i class="fas fa-file-pdf me-2"></i>Generate PDF Report';
        });
    });
    
    // Update vulnerability gauge
    function updateVulnerabilityGauge(score) {
        // Update text display
        document.getElementById('vulnerability-score').textContent = (score * 100).toFixed(1) + '%';
        
        // Set risk level text and color
        const levelElement = document.getElementById('vulnerability-level');
        if (score > 0.7) {
            levelElement.textContent = 'High Risk';
            levelElement.className = 'risk-high';
        } else if (score > 0.4) {
            levelElement.textContent = 'Medium Risk';
            levelElement.className = 'risk-medium';
        } else {
            levelElement.textContent = 'Low Risk';
            levelElement.className = 'risk-low';
        }
        
        // Create or update gauge chart
        const ctx = document.getElementById('vulnerability-gauge').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.gaugeChart) {
            window.gaugeChart.destroy();
        }
        
        // Create new chart
        window.gaugeChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [score, 1 - score],
                    backgroundColor: [
                        score > 0.7 ? '#dc3545' : (score > 0.4 ? '#fd7e14' : '#28a745'),
                        '#e9ecef'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                cutout: '70%',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        enabled: false
                    }
                }
            }
        });
    }
    
    // Update vulnerability breakdown
    function updateVulnerabilityBreakdown(breakdown) {
        const list = document.getElementById('vulnerability-list');
        list.innerHTML = '';
        
        for (const [type, details] of Object.entries(breakdown)) {
            const formattedType = type.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const riskClass = details.risk_level === 'High' ? 'risk-high' : 
                            details.risk_level === 'Medium' ? 'risk-medium' : 'risk-low';
            
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between align-items-center';
            li.innerHTML = `
                ${formattedType}
                <span class="${riskClass}">
                    ${(details.score * 100).toFixed(1)}% (${details.risk_level})
                </span>
            `;
            list.appendChild(li);
        }
    }
    
    // Update risk factors chart
    function updateRiskFactorsChart(riskFactors) {
        const labels = [];
        const weights = [];
        const impacts = [];
        
        for (const [factor, details] of Object.entries(riskFactors)) {
            labels.push(factor.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()));
            weights.push(details.weight);
            impacts.push(details.impact);
        }
        
        const ctx = document.getElementById('risk-factors-chart').getContext('2d');
        
        // Destroy existing chart if it exists
        if (window.riskChart) {
            window.riskChart.destroy();
        }
        
        // Create new chart
        window.riskChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Weight',
                        data: weights,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Impact',
                        data: impacts,
                        backgroundColor: 'rgba(255, 99, 132, 0.7)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 1
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Risk Factors Analysis'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + (context.raw * 100).toFixed(1) + '%';
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}